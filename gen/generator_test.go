package gen

import (
	"github.com/google/go-cmp/cmp"
	"testing"
)

func TestGenerate(t *testing.T) {
	tests := []struct {
		name    string
		args    File
		want    string
		wantErr bool
	}{
		{
			name:    "multiple_declare",
			args:    File{
				PkgName:  "example",
				Decls: []*Decl{
					{
						Name:   "InvalidInputParameterErr",
						Code:   "1003",
						Format: "invalid input parameter",
					},
					{
						Name:   "UpdateConflictErr",
						Code:   "1004",
						Format: "other user updated",
					},
				},
			},
			want:    `// generated by errcdgen; DO NOT EDIT
package example

import (
	"errors"
	"gitlab.com/osaki-lab/errcdgen"
)

func NewInvalidInputParameterErr(err error) *errcdgen.CodeError {
	return InvalidInputParameterErr.WithError(err)
}

func IsInvalidInputParameterErr(err error) bool {
	var cerr *errcdgen.CodeError
	if as := errors.As(err, &cerr); as {
		if cerr.Code == InvalidInputParameterErr.Code {
			return true
		}
	}
	return false
}

func NewUpdateConflictErr(err error) *errcdgen.CodeError {
	return UpdateConflictErr.WithError(err)
}

func IsUpdateConflictErr(err error) bool {
	var cerr *errcdgen.CodeError
	if as := errors.As(err, &cerr); as {
		if cerr.Code == UpdateConflictErr.Code {
			return true
		}
	}
	return false
}
`,
			wantErr: false,
		},
		{
			name:    "DisableErr=true",
			args:    File{
				PkgName:  "example",
				Decls: []*Decl{
					{
						Name:             "InvalidInputParameterErr",
						Code:             "1003",
						Format:           "invalid input parameter: %v",
						DisableErr:       true,
					},
				},
			},
			want:    `// generated by errcdgen; DO NOT EDIT
package example

import (
	"errors"
	"gitlab.com/osaki-lab/errcdgen"
)

func NewInvalidInputParameterErr(arg1 interface{}) *errcdgen.CodeError {
	return InvalidInputParameterErr.WithArgs(arg1)
}

func IsInvalidInputParameterErr(err error) bool {
	var cerr *errcdgen.CodeError
	if as := errors.As(err, &cerr); as {
		if cerr.Code == InvalidInputParameterErr.Code {
			return true
		}
	}
	return false
}
`,
			wantErr: false,
		},
		{
			name:    "Label",
			args:    File{
				PkgName:  "example",
				Decls: []*Decl{
					{
						Name:             "InvalidInputParameterErr",
						Code:             "1003",
						Format:           "invalid input parameter: %v",
						Labels: []Label{
							{
								Index:  0,
								Name:   "payload",
								GoType: "[]string",
							},
						},
					},
				},
			},
			want:    `// generated by errcdgen; DO NOT EDIT
package example

import (
	"errors"
	"gitlab.com/osaki-lab/errcdgen"
)

func NewInvalidInputParameterErr(err error, payload []string) *errcdgen.CodeError {
	return InvalidInputParameterErr.WithError(err).WithArgs(payload)
}

func IsInvalidInputParameterErr(err error) bool {
	var cerr *errcdgen.CodeError
	if as := errors.As(err, &cerr); as {
		if cerr.Code == InvalidInputParameterErr.Code {
			return true
		}
	}
	return false
}
`,
			wantErr: false,
		},
		{
			name:    "Multiple_Label",
			args:    File{
				PkgName:  "example",
				Decls: []*Decl{
					{
						Name:             "InvalidInputParameterErr",
						Code:             "1003",
						Format:           "invalid input parameter: str:%v inv:%v",
						Labels: []Label{
							{
								Index:  0,
								Name:   "strArg1",
								GoType: "string",
							},
							{
								Index:  1,
								Name:   "intArg1",
								GoType: "int",
							},
						},
					},
				},
			},
			want:    `// generated by errcdgen; DO NOT EDIT
package example

import (
	"errors"
	"gitlab.com/osaki-lab/errcdgen"
)

func NewInvalidInputParameterErr(err error, strArg1 string, intArg1 int) *errcdgen.CodeError {
	return InvalidInputParameterErr.WithError(err).WithArgs(strArg1, intArg1)
}

func IsInvalidInputParameterErr(err error) bool {
	var cerr *errcdgen.CodeError
	if as := errors.As(err, &cerr); as {
		if cerr.Code == InvalidInputParameterErr.Code {
			return true
		}
	}
	return false
}
`,
			wantErr: false,
		},
		{
			name:    "No_Label_But_Exists_Args",
			args:    File{
				PkgName:  "example",
				Decls: []*Decl{
					{
						Name:             "InvalidInputParameterErr",
						Code:             "1003",
						Format:           "invalid input parameter: key:%v value:%v",
						Labels: []Label{},
					},
				},
			},
			want:    `// generated by errcdgen; DO NOT EDIT
package example

import (
	"errors"
	"gitlab.com/osaki-lab/errcdgen"
)

func NewInvalidInputParameterErr(err error, arg1 interface{}, arg2 interface{}) *errcdgen.CodeError {
	return InvalidInputParameterErr.WithError(err).WithArgs(arg1, arg2)
}

func IsInvalidInputParameterErr(err error) bool {
	var cerr *errcdgen.CodeError
	if as := errors.As(err, &cerr); as {
		if cerr.Code == InvalidInputParameterErr.Code {
			return true
		}
	}
	return false
}
`,
			wantErr: false,
		},
	}
	for _, tt := range tests {
		t.Run(tt.name, func(t *testing.T) {
			got, err := Generate(tt.args.PkgName, tt.args.Decls)
			if (err != nil) != tt.wantErr {
				t.Errorf("Generate() error = %v, wantErr %v", err, tt.wantErr)
				return
			}


			if diff := cmp.Diff(tt.want, string(got)); diff != "" {
				t.Errorf("Traverse() mismatch (-want +got):\n%s", diff)
			}
		})
	}
}