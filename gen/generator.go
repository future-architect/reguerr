package gen

import (
	"bytes"
	"errors"
	"fmt"
	"go/format"
	"os"
	"text/template"
)

const scansText = `
// generated by reguerr; DO NOT EDIT
package {{.Package}}
import (
	"errors"
	"gitlab.com/osaki-lab/reguerr"
)

{{range .Params}}
{{if .DisableErr}}
func New{{.Name}}({{if .ExistArgs}}{{.Args}}{{end}}) *reguerr.CodeError {
	return {{.Name}}{{if .ExistArgs}}.WithArgs({{.ArgValues}}){{end}}
}
{{else}}
func New{{.Name}}(err error{{if .ExistArgs}}, {{.Args}}{{end}}) *reguerr.CodeError {
	return {{.Name}}.WithError(err){{if .ExistArgs}}.WithArgs({{.ArgValues}}){{end}}
}
{{end}}

func Is{{.Name}}(err error) bool {
	var cerr *reguerr.CodeError
	if as := errors.As(err, &cerr); as {
		if cerr.Code == {{.Name}}.Code {
			return true
		}
	}
	return false
}
{{end}}
`

func Generate(pkg string, params []*Decl) ([]byte, error) {
	if len(params) < 1 {
		return nil, errors.New("no params found")
	}

	scansTmpl, err := template.New("reguerr").Parse(scansText)
	if err != nil {
		return nil, err
	}

	buff := new(bytes.Buffer)
	if err := scansTmpl.Execute(buff, map[string]interface{}{"Package": pkg, "Params": params}); err != nil {
		return nil, err
	}

	source, err := format.Source(buff.Bytes())
	if err != nil {
		fmt.Fprintf(os.Stderr, "source format: %v\n", err)
		fmt.Fprintf(os.Stderr, string(buff.Bytes()))
	}

	return source, nil
}
