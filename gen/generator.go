package gen

import (
	"bytes"
	"errors"
	"go/format"
	"text/template"
)

const scansText = `
// generated by errcdgen; DO NOT EDIT
package {{.Package}}
import (
	"gitlab.com/osaki-lab/errcdgen"
)

{{range .Params}}
{{if .DisableErr}}
func New{{.Name}}({{if .LabelEnable}}{{args .Labels}}{{end}}) *errcdgen.CodeError {
	return {{.Name}}{{if .LabelEnable}}.Args({{argValues .Labels}}){{end}}
}
{{else}}
func New{{.Name}}(err error{{if .LabelEnable}}, {{args .Labels}}{{end}}) *errcdgen.CodeError {
	return {{.Name}}.WithError(err){{if .LabelEnable}}.Args({{argValues .Labels}}){{end}}
}
{{end}}
{{end}}
`

func Generate(pkg string, params []*Decl) ([]byte, error) {
	if len(params) < 1 {
		return nil, errors.New("no params found")
	}

	fnMap := template.FuncMap{"args": Args, "argValues": ArgValues}
	scansTmpl, err := template.New("errcdgen").Funcs(fnMap).Parse(scansText)
	if err != nil {
		return nil, err
	}

	buff := new(bytes.Buffer)
	if err := scansTmpl.Execute(buff, map[string]interface{}{"Package": pkg, "Params": params}); err != nil {
		return nil, err
	}

	return format.Source(buff.Bytes())
}

func Args(labels []Label) string {
	var resp = ""
	for _, v := range labels {
		if resp != "" {
			resp += ","
		}
		resp += v.Name + " " + v.GoType
	}
	return resp
}

func ArgValues(labels []Label) string {
	var resp = ""
	for _, v := range labels {
		if resp != "" {
			resp += ","
		}
		resp += v.Name
	}
	return resp
}
