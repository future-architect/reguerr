package gen

import (
	"bytes"
	"errors"
	"go/format"
	"strings"
	"text/template"
)

const scansText = `
// generated by errcdgen; DO NOT EDIT
package {{.Package}}
import (
	"gitlab.com/osaki-lab/errcdgen"
)

{{range .Params}}
{{ if .DisableErr}}
func New{{.Name}}() *errcdgen.CodeError {
	return {{.Name}}
}
{{else}}
func New{{.Name}}(err error) *errcdgen.CodeError {
	return {{.Name}}.WithError(err)
}
{{end}}
{{end}}
`

type Binding struct {
	Name       string
	DisableErr bool
}

func Generate(pkg string, params []Binding) ([]byte, error) {
	if len(params) < 1 {
		return nil, errors.New("no params found")
	}

	fnMap := template.FuncMap{"title": strings.Title}
	scansTmpl, err := template.New("errcdgen").Funcs(fnMap).Parse(scansText)
	if err != nil {
		return nil, err
	}

	buff := new(bytes.Buffer)
	if err := scansTmpl.Execute(buff, map[string]interface{}{"Package": pkg, "Params": params}); err != nil {
		return nil, err
	}

	return format.Source(buff.Bytes())
}
